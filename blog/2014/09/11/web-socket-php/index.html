
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Websoket com PHP - Gustavo Rodrigues</title>
	<meta name="author" content="Gustavo da Silva Rodrigues">

	
	<meta name="description" content="Websoket Com PHP A web como conhecemos é baseada em solicitação/resposta de HTTP, ou seja, em cada site que você acessa, em cada solicitação &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Gustavo Rodrigues" type="application/atom+xml">
	
	<link rel="canonical" href="http://gustavobeavis.github.io/blog/2014/09/11/web-socket-php/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47696850-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("gustavo.beavis@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>
<hgroup>
  <h1><a href="/">Gustavo Rodrigues</a></h1>
  
    <h2 class="subtitle">Web developer</h2>
  
</hgroup>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Arquivo</a></li>
  <li><a href="/blog/sobre">Sobre</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:gustavo.beavis@gmail.com" title="Email">Email</a>
		
		
		
			<a class="google" href="https://plus.google.com/+GustavodaSilvaRodrigues" rel="author" title="Google+">Google+</a>
		
		
			<a class="twitter" href="http://twitter.com/gustavo_s_r" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/gustavobeavis" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Websoket Com PHP</h1>
	<div class="entry-content" itemprop="articleBody"><p>A web como conhecemos é baseada em solicitação/resposta de HTTP, ou seja, em cada site que você acessa, em cada solicitação AJAX que é feita ao servidor, temos uma alocação de um novo processo HTTP que entrará em uma fila pra ser respondido e o tempo de retorno pode variar de acordo com a capacidade do servidor em lidar com esses processos, sejam eles paralelos ou concorrentes, requisições simples ou requisições que dependam de uma grande capacidade computacional.</p>

<p>Agora quando pensamos em uma aplicação de respostas em tempo real, logo nos deparamos com um problema, chamado alta latência, pois, precisaremos consultar nosso servidor muito mais vezes, isso sem contar no número de clientes ativos fazendo requisições ao mesmo recurso ou áreas diferentes do mesmo sistema, causando lentidão no servidor e em casos mais graves, teremos problemas como timeout de execução ou queda do servidor.</p>

<h2>Event loop</h2>

<p>Toda aplicação realtime, necessariamente possui um loop de consulta de estado ou evento, isso pode estar tanto do lado cliente como do lado servidor. Esse loop ficará escutando a aplicação aguardando alguma mudança de estado, e caso haja atualização, o sistema deve enviar esses dados, a diferença entre o loop do cliente e o do servidor é que no caso do servidor temos um único serviço que irá ficar escutando todas as requisições e mandando as mudanças em tempo real para todos ou algum cliente específico via socket, já no caso do cliente, teremos um script long pooling em todos os clientes, que irá consultar periodicamente o servidor e receber as possíveis alterações do servidor.</p>

<h2>Primeiro socket PHP</h2>

<p>Para criar um socket com php, você deve seguir 6 passos, que vão da abertura de um socket até remover a mascara da mensagem resolver seu encode.</p>

<h4>Passos:</h4>

<ol>
<li>Abrir um socket.</li>
<li>Vincular a um endereço.</li>
<li>Escutar conexões de entrada</li>
<li>Aceitar conexões</li>
<li>WebSocket Handshake.</li>
<li>Unmask/Encode data frames.</li>
</ol>


<h3>Passo 1 &ndash; Abrir um socket:</h3>

<p>Primeiro vamos criar um socket com  <em><a href="http://php.net/manual/pt_BR/function.socket-create.php">socket_create</a>(Domain, Type, Protocol)</em> do PHP:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$socket</span> <span class="o">=</span> <span class="nb">socket_create</span><span class="p">(</span><span class="nx">AF_INET</span><span class="p">,</span> <span class="nx">SOCK_STREAM</span><span class="p">,</span> <span class="nx">SOL_TCP</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Passo 2 &ndash; Vincular a um endereço:</h3>

<p><em><a href="http://php.net/manual/pt_BR/function.socket-bind.php">socket_bind()</a></em> passa o nome dado em address para o socket descrito por socket, que deve ser um resource socket válido criado com <em><a href="http://php.net/manual/pt_BR/function.socket-create.php">socket_create</a></em>.
Isto tem que ser feito antes que uma conexão seja estabelecida, usando <em><a href="http://php.net/manual/pt_BR/function.socket-connect.php">socket_connect ()</a></em> ou <em><a href="http://php.net/manual/pt_BR/function.socket-listen.php">socket_listen ()</a></em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nb">socket_bind</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Passo 3 &ndash; Escutar conexões de entrada</h3>

<p>Após o socket socket ter sido criado usando <em><a href="http://php.net/manual/pt_BR/function.socket-create.php">socket_create</a></em> e associado para um nome com <em><a href="http://php.net/manual/pt_BR/function.socket-bind.php">socket_bind()</a></em> , ele deve dizer para aguardar por escuta em conexões que irão entrar socket com o <em><a href="http://php.net/manual/pt_BR/function.socket-listen.php">socket_listen ()</a></em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nb">socket_listen</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Passo 4 &ndash; Aceitar conexões</h3>

<p>Após o socket socket ter sido criado usando <em><a href="http://php.net/manual/pt_BR/function.socket-create.php">socket_create()</a></em>, passar um nome com  <em><a href="http://php.net/manual/pt_BR/function.socket-bind.php">socket_bind()</a></em>, e dizer para listar conexões com <em><a href="http://php.net/manual/pt_BR/function.socket-listen.php">socket_listen ()</a></em>, a função <em><a href="http://php.net/manual/pt_BR/function.socket-accept.php">socket_accept()</a></em> irá aceitar conexões vindas neste socket. Uma vez que uma conexão com sucesso é feita, um novo &ldquo;resource&rdquo; do socket é retornado, que deve ser usado para comunicação. Se há múltiplas conexões na fila do socket, a primeira irá ser usada. Se não há conexões pendentes, socket_accept() irá bloquear até que uma conexão esteja presente.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nb">socket_accept</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span> 
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>Passo 5 &ndash; WebSocket Handshake</h3>

<p>O cliente tem de apresentar-se, enviando uma solicitação WebSocket handshake para estabelecer uma conexão bem sucedida com o servidor,  o pedido contém um Sec-WebSocket-Key que é uma chave em base64 de 16 bytes</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="nv">$secKey</span> <span class="o">=</span> <span class="nv">$headers</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Key&#39;</span><span class="p">];</span>
</span><span class='line'><span class="nv">$secAccept</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;H*&#39;</span><span class="p">,</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$secKey</span> <span class="o">.</span> <span class="s1">&#39;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#39;</span><span class="p">)));</span>
</span><span class='line'><span class="nv">$upgrade</span>  <span class="o">=</span> <span class="s2">&quot;HTTP/1.1 101 Web Socket Protocol Handshake</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'><span class="s2">&quot;Upgrade: websocket</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'><span class="s2">&quot;Connection: Upgrade</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'><span class="s2">&quot;WebSocket-Origin: </span><span class="si">$host</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'><span class="s2">&quot;WebSocket-Location: ws://</span><span class="si">$host</span><span class="s2">:</span><span class="si">$port</span><span class="s2">/deamon.php</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span>
</span><span class='line'><span class="s2">&quot;Sec-WebSocket-Accept:</span><span class="si">$secAccept</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nb">socket_write</span><span class="p">(</span><span class="nv">$client_conn</span><span class="p">,</span><span class="nv">$upgrade</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$upgrade</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Passo 6 &ndash; Unmask/Encode data frames.</h3>

<p>Depois de fazer handshaking, o cliente pode enviar e receber mensagens, mas as mensagens enviadas são todas criptografadas, por isso, se queremos exibi-las, precisamos remover a mascara de cada frame de dado, conforme o <a href="http://tools.ietf.org/html/rfc6455#section-5.2">rfc6455</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="c1">//Unmask incoming framed message</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">unmask</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$length</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$text</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$length</span> <span class="o">==</span> <span class="mi">126</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$masks</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$masks</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$masks</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nv">$text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$text</span> <span class="o">.=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">^</span> <span class="nv">$masks</span><span class="p">[</span><span class="nv">$i</span><span class="o">%</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$text</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Encode message for transfer to client.</span>
</span><span class='line'><span class="k">function</span> <span class="nf">mask</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$b1</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;</span> <span class="mi">125</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;CCn&#39;</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;=</span> <span class="mi">65536</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;CCNN&#39;</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$header</span><span class="o">.</span><span class="nv">$text</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Exemplo Completo</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="nv">$host</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$port</span> <span class="o">=</span> <span class="s1">&#39;1234&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$null</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//TCP/IP sream</span>
</span><span class='line'><span class="nv">$socket</span> <span class="o">=</span> <span class="nb">socket_create</span><span class="p">(</span><span class="nx">AF_INET</span><span class="p">,</span> <span class="nx">SOCK_STREAM</span><span class="p">,</span> <span class="nx">SOL_TCP</span><span class="p">);</span>
</span><span class='line'><span class="c1">//reuseable port</span>
</span><span class='line'><span class="nb">socket_set_option</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nx">SOL_SOCKET</span><span class="p">,</span> <span class="nx">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//bind socket to specified host</span>
</span><span class='line'><span class="nb">socket_bind</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//listen to port</span>
</span><span class='line'><span class="nb">socket_listen</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//create &amp; add listning socket to the list</span>
</span><span class='line'><span class="nv">$clients</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//start endless loop, so that our script doesn&#39;t stop</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//manage multipal connections</span>
</span><span class='line'>    <span class="nv">$changed</span> <span class="o">=</span> <span class="nv">$clients</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">//returns the socket resources in $changed array</span>
</span><span class='line'>    <span class="nb">socket_select</span><span class="p">(</span><span class="nv">$changed</span><span class="p">,</span> <span class="nv">$null</span><span class="p">,</span> <span class="nv">$null</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//check for new socket</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$changed</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$socket_new</span> <span class="o">=</span> <span class="nb">socket_accept</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span> <span class="c1">//accpet new socket</span>
</span><span class='line'>        <span class="nv">$clients</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$socket_new</span><span class="p">;</span> <span class="c1">//add socket to client array</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">socket_read</span><span class="p">(</span><span class="nv">$socket_new</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span> <span class="c1">//read data sent by the socket</span>
</span><span class='line'>        <span class="nx">perform_handshaking</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$socket_new</span><span class="p">,</span> <span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">);</span> <span class="c1">//perform websocket handshake</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">socket_getpeername</span><span class="p">(</span><span class="nv">$socket_new</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">);</span> <span class="c1">//get ip address of connected socket</span>
</span><span class='line'>        <span class="nv">$response</span> <span class="o">=</span> <span class="nx">mask</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="o">=&gt;</span><span class="nv">$ip</span><span class="o">.</span><span class="s1">&#39; connected&#39;</span><span class="p">)));</span> <span class="c1">//prepare json data</span>
</span><span class='line'>        <span class="nx">send_message</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span> <span class="c1">//notify all users about new connection</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//make room for new socket</span>
</span><span class='line'>        <span class="nv">$found_socket</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$changed</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">unset</span><span class="p">(</span><span class="nv">$changed</span><span class="p">[</span><span class="nv">$found_socket</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//loop through all connected sockets</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$changed</span> <span class="k">as</span> <span class="nv">$changed_socket</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//check for any incomming data</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="nb">socket_recv</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="nv">$buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nv">$received_text</span> <span class="o">=</span> <span class="nx">unmask</span><span class="p">(</span><span class="nv">$buf</span><span class="p">);</span> <span class="c1">//unmask data</span>
</span><span class='line'>            <span class="nv">$tst_msg</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$received_text</span><span class="p">);</span> <span class="c1">//json decode</span>
</span><span class='line'>            <span class="nv">$user_name</span> <span class="o">=</span> <span class="nv">$tst_msg</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span> <span class="c1">//sender name</span>
</span><span class='line'>            <span class="nv">$user_message</span> <span class="o">=</span> <span class="nv">$tst_msg</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span> <span class="c1">//message text</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//prepare data to be sent to client</span>
</span><span class='line'>            <span class="nv">$response_text</span> <span class="o">=</span> <span class="nx">mask</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;usermsg&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="o">=&gt;</span><span class="nv">$user_name</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="o">=&gt;</span><span class="nv">$user_message</span><span class="p">)));</span>
</span><span class='line'>            <span class="nx">send_message</span><span class="p">(</span><span class="nv">$response_text</span><span class="p">);</span> <span class="c1">//send data</span>
</span><span class='line'>            <span class="k">break</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//exist this loop</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$buf</span> <span class="o">=</span> <span class="o">@</span><span class="nb">socket_read</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="nx">PHP_NORMAL_READ</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$buf</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// check disconnected client</span>
</span><span class='line'>            <span class="c1">// remove client for $clients array</span>
</span><span class='line'>            <span class="nv">$found_socket</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="nv">$clients</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">socket_getpeername</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">unset</span><span class="p">(</span><span class="nv">$clients</span><span class="p">[</span><span class="nv">$found_socket</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//notify all users about disconnected connection</span>
</span><span class='line'>            <span class="nv">$response</span> <span class="o">=</span> <span class="nx">mask</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="o">=&gt;</span><span class="nv">$ip</span><span class="o">.</span><span class="s1">&#39; disconnected&#39;</span><span class="p">)));</span>
</span><span class='line'>            <span class="nx">send_message</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// close the listening socket</span>
</span><span class='line'><span class="nb">socket_close</span><span class="p">(</span><span class="nv">$sock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">send_message</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">global</span> <span class="nv">$clients</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$clients</span> <span class="k">as</span> <span class="nv">$changed_socket</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="o">@</span><span class="nb">socket_write</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span><span class="nv">$msg</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//Unmask incoming framed message</span>
</span><span class='line'><span class="k">function</span> <span class="nf">unmask</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$length</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$text</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$length</span> <span class="o">==</span> <span class="mi">126</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$masks</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$masks</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$masks</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nv">$text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$text</span> <span class="o">.=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">^</span> <span class="nv">$masks</span><span class="p">[</span><span class="nv">$i</span><span class="o">%</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$text</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Encode message for transfer to client.</span>
</span><span class='line'><span class="k">function</span> <span class="nf">mask</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$b1</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;</span> <span class="mi">125</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;CCn&#39;</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;=</span> <span class="mi">65536</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;CCNN&#39;</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$header</span><span class="o">.</span><span class="nv">$text</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//handshake new client.</span>
</span><span class='line'><span class="k">function</span> <span class="nf">perform_handshaking</span><span class="p">(</span><span class="nv">$receved_header</span><span class="p">,</span><span class="nv">$client_conn</span><span class="p">,</span> <span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$headers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$lines</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="s2">&quot;/</span><span class="se">\r\n</span><span class="s2">/&quot;</span><span class="p">,</span> <span class="nv">$receved_header</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$lines</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$line</span> <span class="o">=</span> <span class="nb">chop</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/\A(\S+): (.*)\z/&#39;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nv">$headers</span><span class="p">[</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$secKey</span> <span class="o">=</span> <span class="nv">$headers</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Key&#39;</span><span class="p">];</span>
</span><span class='line'>    <span class="nv">$secAccept</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;H*&#39;</span><span class="p">,</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$secKey</span> <span class="o">.</span> <span class="s1">&#39;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#39;</span><span class="p">)));</span>
</span><span class='line'>    <span class="c1">//hand shaking header</span>
</span><span class='line'>    <span class="nv">$upgrade</span>  <span class="o">=</span> <span class="s2">&quot;HTTP/1.1 101 Web Socket Protocol Handshake</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>        <span class="s2">&quot;Upgrade: websocket</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>        <span class="s2">&quot;Connection: Upgrade</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>        <span class="s2">&quot;WebSocket-Origin: </span><span class="si">$host</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">.</span>
</span><span class='line'>        <span class="s2">&quot;WebSocket-Location: ws://</span><span class="si">$host</span><span class="s2">:</span><span class="si">$port</span><span class="s2">/demo/shout.php</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span>
</span><span class='line'>        <span class="s2">&quot;Sec-WebSocket-Accept:</span><span class="si">$secAccept</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">socket_write</span><span class="p">(</span><span class="nv">$client_conn</span><span class="p">,</span><span class="nv">$upgrade</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$upgrade</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Para executar o Socket basta você acessar o seu terminal e executar o script que serve como servidor, pois se inicia-lo via browser, o seu socket não funcionará.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nx">php</span> <span class="o">-</span><span class="nx">q</span> <span class="nx">path</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">server</span><span class="o">/</span><span class="nx">server</span><span class="o">.</span><span class="nx">php</span>
</span></code></pre></td></tr></table></div></figure>


<p>Veja o Exemplo completo no <a href="https://github.com/gustavobeavis/ws_pure_php"><strong>github</strong></a></p>

<h2>O React PHP</h2>

<p>O React PHP é uma biblioteca que foi criada para suprir uma necessidade crescente de computação reativa, ela fornece entre outras coisas a possibilidade de criar aplicações com IO não blocante, como o NodeJS.</p>

<h2>Um chat com React e Ratchet</h2>

<p>O Rachet possui um conjunto de soluções que abstraem e facilitam a criação, manutenção, envios e recebimentos de mensagens de um socket.
Você terá que gerênciar os eventos do seu socket, com as funções.</p>

<h3>Funções</h3>

<ol>
<li>onOpen</li>
<li>onMessage</li>
<li>onClose</li>
<li>onError</li>
</ol>


<h3>onOpen</h3>

<p>Essa função é chamada assim que ocorre uma nova conexão, nela você usa um metodo para guardar a nova conexão para enviar mensagens</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">onOpen</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$conn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Store the new connection to send messages to later</span>
</span><span class='line'>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="nv">$conn</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">echo</span> <span class="s2">&quot;New connection! (</span><span class="si">{</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>onMessage</h3>

<p>Essa função é chamada quando o evento de existe uma nova mensagem, e com ela, você pode encaminhar essas mensagens para todos ou para alguns clientes conectados ao socket</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$numRecv</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;Connection %d sending message &quot;%s&quot; to %d other connection%s&#39;</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="p">,</span> <span class="nv">$from</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$numRecv</span><span class="p">,</span> <span class="nv">$numRecv</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;s&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$dados</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$dados</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$from</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span> <span class="k">as</span> <span class="nv">$client</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// The sender is not the receiver, send to each client connected</span>
</span><span class='line'>            <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$dados</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>onClose</h3>

<p>Essa função é chamada assim que um um cliente se desconecta do websocket, e apartir dele, você pode atribuir callbacks para esse evento.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">onClose</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$conn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// The connection is closed, remove it, as we can no longer send it messages</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span><span class="o">-&gt;</span><span class="na">detach</span><span class="p">(</span><span class="nv">$conn</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">echo</span> <span class="s2">&quot;Connection </span><span class="si">{</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="si">}</span><span class="s2"> has disconnected</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>onError</h3>

<p>Esse evento é disparado quando ocorre um erro interno no servidor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">onError</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$conn</span><span class="p">,</span> <span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">echo</span> <span class="s2">&quot;An error has occurred: </span><span class="si">{</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Classe completa</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">namespace</span> <span class="nx">MyApp</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Ratchet\MessageComponentInterface</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Ratchet\ConnectionInterface</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Chat</span> <span class="k">implements</span> <span class="nx">MessageComponentInterface</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$clients</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\SplObjectStorage</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">onOpen</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$conn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Store the new connection to send messages to later</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="nv">$conn</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;New connection! (</span><span class="si">{</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$numRecv</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;Connection %d sending message &quot;%s&quot; to %d other connection%s&#39;</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>            <span class="p">,</span> <span class="nv">$from</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$numRecv</span><span class="p">,</span> <span class="nv">$numRecv</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;s&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$dados</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$dados</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$from</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span> <span class="k">as</span> <span class="nv">$client</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// The sender is not the receiver, send to each client connected</span>
</span><span class='line'>                <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$dados</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">onClose</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$conn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// The connection is closed, remove it, as we can no longer send it messages</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clients</span><span class="o">-&gt;</span><span class="na">detach</span><span class="p">(</span><span class="nv">$conn</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Connection </span><span class="si">{</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">resourceId</span><span class="si">}</span><span class="s2"> has disconnected</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">onError</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$conn</span><span class="p">,</span> <span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;An error has occurred: </span><span class="si">{</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">###Startando seu socket</span>
</span><span class='line'><span class="nx">Agora</span> <span class="nx">que</span> <span class="nx">voc</span><span class="err">ê</span> <span class="nx">tem</span> <span class="nx">seus</span> <span class="nx">metodos</span><span class="p">,</span> <span class="nx">agora</span> <span class="nx">voc</span><span class="err">ê</span> <span class="nx">precisa</span> <span class="nx">criar</span> <span class="nx">um</span> <span class="nx">arquivo</span> <span class="nx">para</span> <span class="nx">instanciar</span> <span class="nx">a</span> <span class="nx">classe</span> <span class="nx">criada</span> <span class="nx">e</span> <span class="nx">para</span> <span class="nx">servir</span> <span class="nx">como</span> <span class="nx">socket</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Ratchet\Server\IoServer</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Ratchet\Http\HttpServer</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Ratchet\WebSocket\WsServer</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">MyApp\Chat</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">require</span> <span class="s1">&#39;vendor/autoload.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$server</span> <span class="o">=</span> <span class="nx">IoServer</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">HttpServer</span><span class="p">(</span>
</span><span class='line'>        <span class="k">new</span> <span class="nx">WsServer</span><span class="p">(</span>
</span><span class='line'>            <span class="k">new</span> <span class="nx">Chat</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'>    <span class="mi">1234</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Veja o Exemplo completo no <a href="https://github.com/gustavobeavis/ws_react_basic">Github</a></p>

<h2>Vantagens e desvantagens</h2>

<p>A vantagem de usar um websoket é que ao invés de termos muitos clientes fazendo requisições periódicas http ao mesmo endpoint para verificar possíveis mudanças de estado da aplicação, o socket que irá gerenciar as alterações e mandar para o(os) clientes essas atualizações logo que elas ocorrerem, evitando um tráfego desnecessário de requisições http, como consultas de estado sem mudança ou ainda muitos clientes consultando a mesma coisa. Em contra partida, teremos um script executando um loop infinito no servidor, aguardando algum evento para transmitir para os usuários, ou seja, embora você resolva a latência, você terá um processo que irá consumir recursos do servidor durante todo tempo de que você mante-lo rodando, independente se houver ou não novos eventos, solicitações ou usuários ativos.</p>

<p>Além disso, podemos ter situações onde o navegador do cliente não tenha suporte websoket, flash ou java. Nesses casos, não teremos como evitar o uso de long pooling.</p>

<p>O Websoket é o futuro, porém, o PHP não é a melhor saída para esse tipo de recurso, embora funcione bem na maioria dos casos. Eu aconselho o uso de Erlang ou Node JS, por serem linguagens de natureza não blocante e por lidarem melhor com concorrência.</p>

<h2>Aplicações</h2>

<p>Os websockets podem ter muitas aplicações, sobre tudo, em:</p>

<ul>
<li>Chats</li>
<li>Games multi-player online</li>
<li>Sistemas de sincronização mobile/Web</li>
<li>sistemas que dependam de modo geral de informações em tempo rel</li>
</ul>


<h2>Referências</h2>

<ul>
<li><p><a href="http://www.html5rocks.com/pt/tutorials/websockets/basics/">HTML5 Rocks &ndash; Apresentando WebSockets &ndash; PT</a></p></li>
<li><p><a href="https://docs.google.com/presentation/d/1BVyBcR5AE2kwY7akcmM0O3dDJ5TccY3ew0U9Ux7wsQs/pub?start=false&amp;loop=false&amp;delayms=3000&amp;utm_content=buffer7886e&amp;utm_medium=social&amp;utm_source=twitter.com&amp;utm_campaign=buffer#slide=id.p">Sergio Lopes &ndash; SPYD e HTTP 2.0 &ndash; PT</a></p></li>
<li><p><a href="http://blog.glaucocustodio.com/2012/09/22/otimizando-performance-com-compactacao-gzip-deflate/">JustCode &ndash; Otimizando Performance com Compactação Gzip/Deflate</a></p></li>
<li><p><a href="http://www.sanwebe.com/2013/05/chat-using-websocket-php-socket">Sanwebe &ndash; mple Chat Using WebSocket and PHP Socket &ndash; EN</a></p></li>
<li><p><a href="http://socketo.me/">Ratchet &ndash; Lib</a></p></li>
<li><p><a href="http://socket.io/">socket.io</a></p></li>
</ul>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2014 - Gustavo da Silva Rodrigues -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			

<script type="text/javascript">
      var disqus_shortname = 'gustavobeavisgithubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://gustavobeavis.github.io/blog/2014/09/11/web-socket-php/';
        var disqus_url = 'http://gustavobeavis.github.io/blog/2014/09/11/web-socket-php/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





		</div>
	</div>
</body>
</html>
